# GameController 可调节窗口 - 架构设计

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Tauri 窗口层                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  窗口配置 (tauri.conf.json)                           │  │
│  │  - resizable: true                                    │  │
│  │  - width: 1400, height: 900                          │  │
│  │  - minWidth: 1000, minHeight: 700                    │  │
│  └───────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  原生窗口控制                                          │  │
│  │  - 拖拽边缘/角落调整大小                              │  │
│  │  - 最小/最大尺寸限制                                  │  │
│  │  - 窗口装饰（标题栏、边框）                           │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                    WebView 渲染层                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  HTML/CSS/JavaScript                                  │  │
│  │  - React 组件树                                       │  │
│  │  - Tailwind CSS 样式                                  │  │
│  │  - Flexbox 布局引擎                                   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                    React 组件层                              │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  Index (根组件)                                     │    │
│  │  └─ Main (主界面)                                   │    │
│  │     ├─ TeamPanel (左侧队伍面板)                     │    │
│  │     │  ├─ TeamHeader                                │    │
│  │     │  ├─ ActionButtons                             │    │
│  │     │  ├─ PlayerButtons (可滚动)                    │    │
│  │     │  └─ FreeKickButtons                           │    │
│  │     │                                                │    │
│  │     ├─ CenterPanel (中央控制面板)                   │    │
│  │     │  ├─ ClockPanel                                │    │
│  │     │  ├─ StatePanel                                │    │
│  │     │  └─ PenaltyPanel                              │    │
│  │     │                                                │    │
│  │     ├─ TeamPanel (右侧队伍面板)                     │    │
│  │     │  └─ (同左侧结构)                              │    │
│  │     │                                                │    │
│  │     └─ UndoPanel (底部撤销面板)                     │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 布局层次结构

```
┌─────────────────────────────────────────────────────────────┐
│  gc-container (垂直 Flexbox)                                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  主内容区 (flex-1, 水平 Flexbox)                       │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │  │
│  │  │ TeamPanel│  │  Center  │  │ TeamPanel│            │  │
│  │  │  (左侧)  │  │  Panel   │  │  (右侧)  │            │  │
│  │  │          │  │          │  │          │            │  │
│  │  │ flex-1   │  │ flex-1   │  │ flex-1   │            │  │
│  │  │ min-280px│  │ min-300px│  │ min-280px│            │  │
│  │  │ max-400px│  │          │  │ max-400px│            │  │
│  │  └──────────┘  └──────────┘  └──────────┘            │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  UndoPanel (flex-shrink-0, 固定高度)                   │  │
│  │  [Undo] [Undo] [Undo] ...                             │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## TeamPanel 内部结构

```
┌─────────────────────────────────────┐
│  TeamPanel (垂直 Flexbox)            │
│  ┌───────────────────────────────┐  │
│  │  TeamHeader (flex-shrink-0)   │  │
│  │  队名 + 开球指示器             │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  控制按钮区 (flex-shrink-0)   │  │
│  │  [Substitute] [Timeout] [Goal]│  │
│  │  + 队伍统计信息                │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  玩家列表区 (flex-1)          │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │ overflow-y-auto         │  │  │
│  │  │ [Player 1]              │  │  │
│  │  │ [Player 2]              │  │  │
│  │  │ [Player 3]              │  │  │
│  │  │ ...                     │  │  │
│  │  │ [Player N]              │  │  │
│  │  └─────────────────────────┘  │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  FreeKickButtons              │  │
│  │  (flex-shrink-0)              │  │
│  │  [Goal Kick] [Kick-in] [...]  │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

## 响应式布局流程

```
窗口大小变化
    ↓
Tauri 窗口事件
    ↓
WebView 视口调整
    ↓
CSS Flexbox 重新计算
    ↓
┌─────────────────────────────────────┐
│  宽度分配策略                        │
│  1. 计算可用宽度                    │
│  2. 减去 padding 和 gap             │
│  3. 分配给 flex-1 元素              │
│  4. 应用 min-width/max-width 限制   │
│  5. 重新分配剩余空间                │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  高度分配策略                        │
│  1. 计算可用高度                    │
│  2. 减去固定高度元素                │
│  3. 分配给 flex-1 元素              │
│  4. 触发 overflow 滚动（如需要）    │
└─────────────────────────────────────┘
    ↓
React 组件重新渲染
    ↓
界面更新完成
```

## 尺寸约束系统

```
┌─────────────────────────────────────────────────────────┐
│  窗口尺寸约束                                            │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Tauri 层                                         │  │
│  │  - minWidth: 1000px                              │  │
│  │  - minHeight: 700px                              │  │
│  │  - maxWidth: 无限制（屏幕大小）                   │  │
│  │  - maxHeight: 无限制（屏幕大小）                  │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  组件尺寸约束                                            │
│  ┌───────────────────────────────────────────────────┐  │
│  │  TeamPanel                                        │  │
│  │  - minWidth: 280px                               │  │
│  │  - maxWidth: 400px                               │  │
│  │  - flex: 1 (弹性宽度)                            │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  CenterPanel                                      │  │
│  │  - minWidth: 300px                               │  │
│  │  - maxWidth: 无限制                               │  │
│  │  - flex: 1 (弹性宽度)                            │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  UndoPanel                                        │  │
│  │  - height: 40px (固定)                           │  │
│  │  - flex-shrink: 0 (不收缩)                       │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 宽度分配算法

```
输入：窗口宽度 W

步骤 1：计算可用宽度
  available = W - padding(16px) - gaps(32px)
  // 假设 W = 1400px
  // available = 1400 - 16 - 32 = 1352px

步骤 2：检查最小宽度约束
  minRequired = TeamPanel(280) + CenterPanel(300) + TeamPanel(280)
  // minRequired = 860px
  if (available < minRequired) {
    // 触发水平滚动（不应该发生，因为窗口最小 1000px）
  }

步骤 3：分配宽度
  if (available <= 1200px) {
    // 紧凑模式：所有面板使用最小宽度
    TeamPanel = 280px
    CenterPanel = available - 560px
  } else if (available <= 1600px) {
    // 标准模式：按比例分配
    flexUnits = 3 (每个面板 flex: 1)
    unitWidth = available / flexUnits
    TeamPanel = min(unitWidth, 400px)
    CenterPanel = available - 2 * TeamPanel
  } else {
    // 宽松模式：TeamPanel 达到最大宽度
    TeamPanel = 400px
    CenterPanel = available - 800px
  }

输出：各面板实际宽度
```

## 高度分配算法

```
输入：窗口高度 H

步骤 1：计算可用高度
  available = H - padding(16px) - UndoPanel(40px) - gaps(16px)
  // 假设 H = 900px
  // available = 900 - 16 - 40 - 16 = 828px

步骤 2：分配给主内容区
  mainContentHeight = available

步骤 3：TeamPanel 内部分配
  fixed = TeamHeader(60px) + Controls(80px) + FreeKickButtons(40px) + gaps(24px)
  // fixed = 204px
  playerListHeight = mainContentHeight - fixed
  // playerListHeight = 828 - 204 = 624px

步骤 4：检查是否需要滚动
  playerCount = 7 (SPL 标准)
  playerButtonHeight = 60px
  requiredHeight = playerCount * (playerButtonHeight + gap)
  // requiredHeight = 7 * 68 = 476px
  
  if (requiredHeight > playerListHeight) {
    // 显示滚动条
    overflow-y: auto
  } else {
    // 无需滚动
    overflow-y: hidden
  }

输出：各区域实际高度 + 滚动状态
```

## CSS Flexbox 布局模型

```
┌─────────────────────────────────────────────────────────┐
│  .gc-container                                           │
│  display: flex                                           │
│  flex-direction: column                                  │
│  width: 100%                                             │
│  height: 100%                                            │
│                                                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │  主内容区                                          │  │
│  │  flex: 1 (占据剩余空间)                           │  │
│  │  display: flex                                     │  │
│  │  flex-direction: row                               │  │
│  │  min-height: 0 (允许收缩)                         │  │
│  │                                                    │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐        │  │
│  │  │ Panel 1  │  │ Panel 2  │  │ Panel 3  │        │  │
│  │  │ flex: 1  │  │ flex: 1  │  │ flex: 1  │        │  │
│  │  └──────────┘  └──────────┘  └──────────┘        │  │
│  └───────────────────────────────────────────────────┘  │
│                                                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │  UndoPanel                                         │  │
│  │  flex-shrink: 0 (不收缩)                          │  │
│  │  height: 40px (固定高度)                          │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 性能优化策略

```
┌─────────────────────────────────────────────────────────┐
│  渲染优化                                                │
│  ┌───────────────────────────────────────────────────┐  │
│  │  1. 使用 CSS transition 而非 JavaScript 动画      │  │
│  │     - GPU 加速                                    │  │
│  │     - 浏览器优化                                  │  │
│  │                                                   │  │
│  │  2. 最小化重排（Reflow）                          │  │
│  │     - 使用 Flexbox 自动计算                       │  │
│  │     - 避免频繁修改 DOM                            │  │
│  │                                                   │  │
│  │  3. 最小化重绘（Repaint）                         │  │
│  │     - 使用 transform 而非 width/height            │  │
│  │     - 合理使用 will-change                        │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  内存优化                                                │
│  ┌───────────────────────────────────────────────────┐  │
│  │  1. 无额外 DOM 节点                               │  │
│  │  2. 无第三方库依赖                                │  │
│  │  3. CSS 样式复用                                  │  │
│  │  4. React 组件缓存                                │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  响应速度优化                                            │
│  ┌───────────────────────────────────────────────────┐  │
│  │  1. 短 transition 时间（0.1s）                    │  │
│  │  2. 使用 ease-out 缓动函数                        │  │
│  │  3. 避免复杂选择器                                │  │
│  │  4. 合理使用 overflow                             │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 事件流程

```
用户拖拽窗口边缘
    ↓
操作系统窗口事件
    ↓
Tauri 窗口管理器
    ↓
检查尺寸约束
    ├─ 小于最小尺寸？ → 限制到最小尺寸
    ├─ 大于最大尺寸？ → 限制到最大尺寸
    └─ 在范围内？ → 允许调整
    ↓
更新窗口尺寸
    ↓
WebView resize 事件
    ↓
浏览器布局引擎
    ├─ 重新计算 Flexbox 布局
    ├─ 应用 CSS 约束
    └─ 触发 transition 动画
    ↓
React 组件更新
    ├─ 检测尺寸变化
    ├─ 更新滚动状态
    └─ 重新渲染（如需要）
    ↓
界面更新完成
    ↓
用户看到新布局
```

## 数据流

```
┌─────────────────────────────────────────────────────────┐
│  状态管理                                                │
│  ┌───────────────────────────────────────────────────┐  │
│  │  React State (不变)                               │  │
│  │  - game                                           │  │
│  │  - connectionStatus                               │  │
│  │  - legalActions                                   │  │
│  │  - params                                         │  │
│  │  - teamNames                                      │  │
│  │  - undoActions                                    │  │
│  └───────────────────────────────────────────────────┘  │
│                    ↓                                     │
│  ┌───────────────────────────────────────────────────┐  │
│  │  CSS 布局状态 (动态)                              │  │
│  │  - 窗口宽度/高度                                  │  │
│  │  - 面板宽度/高度                                  │  │
│  │  - 滚动位置                                       │  │
│  │  - overflow 状态                                  │  │
│  └───────────────────────────────────────────────────┘  │
│                    ↓                                     │
│  ┌───────────────────────────────────────────────────┐  │
│  │  渲染输出                                          │  │
│  │  - DOM 树                                         │  │
│  │  - 样式计算                                       │  │
│  │  - 布局计算                                       │  │
│  │  - 绘制                                           │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘

注意：窗口大小变化不影响 React State，
      仅影响 CSS 布局状态，因此不会触发状态丢失。
```

## 关键设计决策

### 1. 为什么选择 Flexbox？

```
优点：
✓ 浏览器原生支持，性能好
✓ 自动计算布局，代码简洁
✓ 响应式能力强
✓ 无需第三方库

缺点：
✗ 不支持复杂网格布局（本项目不需要）
✗ 旧浏览器兼容性（Tauri 使用现代 WebView，无问题）
```

### 2. 为什么使用 Tauri 原生窗口？

```
优点：
✓ 跨平台一致性
✓ 系统原生体验
✓ 无需额外代码
✓ 性能最优

缺点：
✗ 依赖 Tauri 版本（已满足）
✗ 配置相对固定（可接受）
```

### 3. 为什么不使用 CSS Grid？

```
Flexbox vs Grid：
- Flexbox：一维布局，适合本项目的行/列布局
- Grid：二维布局，适合复杂网格

本项目布局特点：
- 主要是水平/垂直一维布局
- 不需要复杂的网格对齐
- Flexbox 更简单直观

结论：Flexbox 是最佳选择
```

### 4. 为什么设置最小尺寸为 1000x700？

```
考虑因素：
1. 内容可见性
   - 两个 TeamPanel (280px * 2 = 560px)
   - 一个 CenterPanel (300px)
   - padding 和 gap (约 100px)
   - 总计：约 960px
   - 留有余量：1000px

2. 功能可用性
   - 所有按钮可见
   - 玩家列表至少显示 5 个
   - 控制面板完整显示

3. 屏幕兼容性
   - 1366x768 (常见小屏幕) 可以容纳
   - 1920x1080 (标准屏幕) 舒适使用
   - 2560x1440+ (大屏幕) 宽松布局

结论：1000x700 是平衡点
```

## 总结

该架构设计具有以下特点：

1. **简洁性**：使用原生技术，无复杂依赖
2. **高效性**：浏览器优化，性能出色
3. **可维护性**：代码清晰，易于理解
4. **可扩展性**：易于添加新面板或功能
5. **跨平台性**：Tauri 保证一致体验

通过合理的层次划分和约束设计，实现了"终端式"的可调节窗口体验。

---

**设计者**：Kiro AI Assistant  
**完成日期**：2026-01-27  
**版本**：v1.0.0
